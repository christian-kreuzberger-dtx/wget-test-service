dist: xenial
language: bash
services:
  - docker
env:
  global:
    - GO111MODULE=on
    - GOPROXY=https://proxy.golang.org

jobs:
  include:
    - stage: codestyle
      # Check Codestyle using go fmt
      services: []
      language: go
      go:
        - 1.12.x
      # skip install
      install: true
      script:
        - set -e
        - echo "blabla"
        - # this will cause an error
        - echo "Checking code style..."
        - ls -la /bla # this will exit with an unknown code
        - unformatted=$(gofmt -l .)
        - |
          if [ ! -z "$unformatted" ]; then
            echo "Code Style Check failed for the following files: ${unformatted}".
            echo "Please run: gofmt -w ."
            echo "After that ammend your commit (e.g.: git add ${unformatted} && git commit --amend --no-edit) and force push the changes (git push -f)."
            travis_terminate 1
          fi
      after_success:
        - echo "Success!"
      after_failure:
        - echo "Failed"
        - ls -la /

    - stage: tests
      # Run tests
      services: []
      language: go
      if: type = pull_request
      go:
        - 1.12.x
      # cache some go files
      cache:
        directories:
          - $HOME/.cache/go-build
          - $HOME/gopath/pkg/mod
      script:
        - go build ./...
        - go test -race -v ./...
